// SWIFT_ENABLE_TENSORFLOW
// RUN: %target-sil-opt -assume-parsing-unqualified-ownership-sil %s -module-name=witness_tables_autodiff | %target-sil-opt -assume-parsing-unqualified-ownership-sil -module-name=witness_tables_autodiff | %FileCheck %s

sil_stage canonical

import Builtin
import Swift
import SwiftShims

protocol DifferentiableRequirement {
  @differentiable(reverse)
  func f(_ x: Float) -> Float
}

struct DifferentiableConformance : DifferentiableRequirement {
  @differentiable(reverse, jvp: df, vjp: pf)
  func f(_ x: Float) -> Float
  func df(_ x: Float) -> (Float, (Float) -> Float)
  func pf(_ x: Float) -> (Float, (Float) -> Float)
  init()
}

struct AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__Type__src_0_wrt_0 {
}

// main
sil @main : $@convention(c) (Int32, UnsafeMutablePointer<Optional<UnsafeMutablePointer<Int8>>>) -> Int32 {
bb0(%0 : $Int32, %1 : $UnsafeMutablePointer<Optional<UnsafeMutablePointer<Int8>>>):
  %2 = integer_literal $Builtin.Int32, 0          // user: %3
  %3 = struct $Int32 (%2 : $Builtin.Int32)        // user: %4
  return %3 : $Int32                              // id: %4
} // end sil function 'main'

// DifferentiableConformance.f(_:)
sil hidden [differentiable source 0 wrt 0 primal @AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__primal_src_0_wrt_0 adjoint @AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__adjoint_src_0_wrt_0 jvp @$s23witness_tables_autodiff25DifferentiableConformanceV2dfySf_S2fctSfF vjp @$s23witness_tables_autodiff25DifferentiableConformanceV2pfySf_S2fctSfF] @$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF : $@convention(method) (Float, DifferentiableConformance) -> Float {
// %0                                             // users: %4, %2
// %1                                             // user: %3
bb0(%0 : $Float, %1 : $DifferentiableConformance):
  debug_value %0 : $Float, let, name "x", argno 1 // id: %2
  debug_value %1 : $DifferentiableConformance, let, name "self", argno 2 // id: %3
  return %0 : $Float                              // id: %4
} // end sil function '$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF'

// DifferentiableConformance.df(_:)
sil hidden @$s23witness_tables_autodiff25DifferentiableConformanceV2dfySf_S2fctSfF : $@convention(method) (Float, DifferentiableConformance) -> (Float, @owned @callee_guaranteed (Float) -> Float) {
// %0                                             // users: %6, %2
// %1                                             // user: %3
bb0(%0 : $Float, %1 : $DifferentiableConformance):
  debug_value %0 : $Float, let, name "x", argno 1 // id: %2
  debug_value %1 : $DifferentiableConformance, let, name "self", argno 2 // id: %3
  // function_ref closure #1 in DifferentiableConformance.df(_:)
  %4 = function_ref @$s23witness_tables_autodiff25DifferentiableConformanceV2dfySf_S2fctSfFS2fcfU_ : $@convention(thin) (Float) -> Float // user: %5
  %5 = thin_to_thick_function %4 : $@convention(thin) (Float) -> Float to $@callee_guaranteed (Float) -> Float // user: %6
  %6 = tuple (%0 : $Float, %5 : $@callee_guaranteed (Float) -> Float) // user: %7
  return %6 : $(Float, @callee_guaranteed (Float) -> Float) // id: %7
} // end sil function '$s23witness_tables_autodiff25DifferentiableConformanceV2dfySf_S2fctSfF'

// DifferentiableConformance.pf(_:)
sil hidden @$s23witness_tables_autodiff25DifferentiableConformanceV2pfySf_S2fctSfF : $@convention(method) (Float, DifferentiableConformance) -> (Float, @owned @callee_guaranteed (Float) -> Float) {
// %0                                             // users: %6, %2
// %1                                             // user: %3
bb0(%0 : $Float, %1 : $DifferentiableConformance):
  debug_value %0 : $Float, let, name "x", argno 1 // id: %2
  debug_value %1 : $DifferentiableConformance, let, name "self", argno 2 // id: %3
  // function_ref closure #1 in DifferentiableConformance.pf(_:)
  %4 = function_ref @$s23witness_tables_autodiff25DifferentiableConformanceV2pfySf_S2fctSfFS2fcfU_ : $@convention(thin) (Float) -> Float // user: %5
  %5 = thin_to_thick_function %4 : $@convention(thin) (Float) -> Float to $@callee_guaranteed (Float) -> Float // user: %6
  %6 = tuple (%0 : $Float, %5 : $@callee_guaranteed (Float) -> Float) // user: %7
  return %6 : $(Float, @callee_guaranteed (Float) -> Float) // id: %7
} // end sil function '$s23witness_tables_autodiff25DifferentiableConformanceV2pfySf_S2fctSfF'

// closure #1 in DifferentiableConformance.df(_:)
sil private @$s23witness_tables_autodiff25DifferentiableConformanceV2dfySf_S2fctSfFS2fcfU_ : $@convention(thin) (Float) -> Float {
// %0                                             // users: %2, %1
bb0(%0 : $Float):
  debug_value %0 : $Float, let, name "v", argno 1 // id: %1
  return %0 : $Float                              // id: %2
} // end sil function '$s23witness_tables_autodiff25DifferentiableConformanceV2dfySf_S2fctSfFS2fcfU_'

// closure #1 in DifferentiableConformance.pf(_:)
sil private @$s23witness_tables_autodiff25DifferentiableConformanceV2pfySf_S2fctSfFS2fcfU_ : $@convention(thin) (Float) -> Float {
// %0                                             // users: %2, %1
bb0(%0 : $Float):
  debug_value %0 : $Float, let, name "v", argno 1 // id: %1
  return %0 : $Float                              // id: %2
} // end sil function '$s23witness_tables_autodiff25DifferentiableConformanceV2pfySf_S2fctSfFS2fcfU_'

// DifferentiableConformance.init()
sil hidden @$s23witness_tables_autodiff25DifferentiableConformanceVACycfC : $@convention(method) (@thin DifferentiableConformance.Type) -> DifferentiableConformance {
bb0(%0 : $@thin DifferentiableConformance.Type):
  %1 = alloc_stack $DifferentiableConformance, var, name "self" // user: %3
  %2 = struct $DifferentiableConformance ()       // user: %4
  dealloc_stack %1 : $*DifferentiableConformance  // id: %3
  return %2 : $DifferentiableConformance          // id: %4
} // end sil function '$s23witness_tables_autodiff25DifferentiableConformanceVACycfC'

// protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
sil private [transparent] [thunk] @$s23witness_tables_autodiff25DifferentiableConformanceVAA0D11RequirementA2aDP1fyS2fFTW : $@convention(witness_method: DifferentiableRequirement) (Float, @in_guaranteed DifferentiableConformance) -> Float {
// %0                                             // user: %4
// %1                                             // user: %2
bb0(%0 : $Float, %1 : $*DifferentiableConformance):
  %2 = load %1 : $*DifferentiableConformance      // user: %4
  // function_ref DifferentiableConformance.f(_:)
  %3 = function_ref @$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF : $@convention(method) (Float, DifferentiableConformance) -> Float // user: %4
  %4 = apply %3(%0, %2) : $@convention(method) (Float, DifferentiableConformance) -> Float // user: %5
  return %4 : $Float                              // id: %5
} // end sil function '$s23witness_tables_autodiff25DifferentiableConformanceVAA0D11RequirementA2aDP1fyS2fFTW'

// jvpSU protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
sil private [transparent] [thunk] @$s3jvp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW : $@convention(witness_method: DifferentiableRequirement) (Float, @in_guaranteed DifferentiableConformance) -> (Float, @owned @callee_guaranteed (Float) -> Float) {
// %0                                             // user: %6
// %1                                             // user: %2
bb0(%0 : $Float, %1 : $*DifferentiableConformance):
  %2 = load %1 : $*DifferentiableConformance      // user: %6
  // function_ref DifferentiableConformance.f(_:)
  %3 = function_ref @$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF : $@convention(method) (Float, DifferentiableConformance) -> Float // user: %4
  %4 = autodiff_function [wrt 0] [order 1] %3 : $@convention(method) (Float, DifferentiableConformance) -> Float // user: %5
  %5 = autodiff_function_extract [jvp] [order 1] %4 : $@autodiff @convention(method) (Float, @nondiff DifferentiableConformance) -> Float // user: %6
  %6 = apply %5(%0, %2) : $@convention(method) (Float, @nondiff DifferentiableConformance) -> (Float, @owned @callee_guaranteed (Float) -> Float) // users: %8, %7
  %7 = tuple_extract %6 : $(Float, @callee_guaranteed (Float) -> Float), 0 // user: %9
  %8 = tuple_extract %6 : $(Float, @callee_guaranteed (Float) -> Float), 1 // user: %9
  %9 = tuple (%7 : $Float, %8 : $@callee_guaranteed (Float) -> Float) // user: %10
  return %9 : $(Float, @callee_guaranteed (Float) -> Float) // id: %10
} // end sil function '$s3jvp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW'

// vjpSU protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
sil private [transparent] [thunk] @$s3vjp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW : $@convention(witness_method: DifferentiableRequirement) (Float, @in_guaranteed DifferentiableConformance) -> (Float, @owned @callee_guaranteed (Float) -> Float) {
// %0                                             // user: %6
// %1                                             // user: %2
bb0(%0 : $Float, %1 : $*DifferentiableConformance):
  %2 = load %1 : $*DifferentiableConformance      // user: %6
  // function_ref DifferentiableConformance.f(_:)
  %3 = function_ref @$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF : $@convention(method) (Float, DifferentiableConformance) -> Float // user: %4
  %4 = autodiff_function [wrt 0] [order 1] %3 : $@convention(method) (Float, DifferentiableConformance) -> Float // user: %5
  %5 = autodiff_function_extract [vjp] [order 1] %4 : $@autodiff @convention(method) (Float, @nondiff DifferentiableConformance) -> Float // user: %6
  %6 = apply %5(%0, %2) : $@convention(method) (Float, @nondiff DifferentiableConformance) -> (Float, @owned @callee_guaranteed (Float) -> Float) // users: %8, %7
  %7 = tuple_extract %6 : $(Float, @callee_guaranteed (Float) -> Float), 0 // user: %9
  %8 = tuple_extract %6 : $(Float, @callee_guaranteed (Float) -> Float), 1 // user: %9
  %9 = tuple (%7 : $Float, %8 : $@callee_guaranteed (Float) -> Float) // user: %10
  return %9 : $(Float, @callee_guaranteed (Float) -> Float) // id: %10
} // end sil function '$s3vjp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW'

// AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__primal_src_0_wrt_0
sil hidden @AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__primal_src_0_wrt_0 : $@convention(method) (Float, DifferentiableConformance) -> (@owned AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__Type__src_0_wrt_0, Float) {
// %0                                             // users: %5, %2
// %1                                             // user: %3
bb0(%0 : $Float, %1 : $DifferentiableConformance):
  debug_value %0 : $Float, let, name "x", argno 1 // id: %2
  debug_value %1 : $DifferentiableConformance, let, name "self", argno 2 // id: %3
  %4 = struct $AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__Type__src_0_wrt_0 () // user: %5
  %5 = tuple (%4 : $AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__Type__src_0_wrt_0, %0 : $Float) // user: %6
  return %5 : $(AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__Type__src_0_wrt_0, Float) // id: %6
} // end sil function 'AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__primal_src_0_wrt_0'

// AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__adjoint_src_0_wrt_0
sil hidden @AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__adjoint_src_0_wrt_0 : $@convention(method) (Float, AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__Type__src_0_wrt_0, Float, Float, DifferentiableConformance) -> Float {
// %0                                             // user: %5
bb0(%0 : $Float, %1 : $AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__Type__src_0_wrt_0, %2 : $Float, %3 : $Float, %4 : $DifferentiableConformance):
  return %0 : $Float                              // id: %5
} // end sil function 'AD__$s23witness_tables_autodiff25DifferentiableConformanceV1fyS2fF__adjoint_src_0_wrt_0'

// CHECK-LABEL: sil_witness_table hidden DifferentiableConformance: DifferentiableRequirement module witness_tables_autodiff {
// CHECK-NEXT:   method #DifferentiableRequirement.f!1: <Self where Self : DifferentiableRequirement> (Self) -> (Float) -> Float : @$s23witness_tables_autodiff25DifferentiableConformanceVAA0D11RequirementA2aDP1fyS2fFTW	// protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
// CHECK-NEXT:   autodiff_associated_function jvp 1 SU #DifferentiableRequirement.f!1: <Self where Self : DifferentiableRequirement> (Self) -> (Float) -> Float : @$s3jvp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW	// jvpSU protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
// CHECK-NEXT:   autodiff_associated_function vjp 1 SU #DifferentiableRequirement.f!1: <Self where Self : DifferentiableRequirement> (Self) -> (Float) -> Float : @$s3vjp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW	// vjpSU protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
// CHECK-NEXT: }

sil_witness_table hidden DifferentiableConformance: DifferentiableRequirement module witness_tables_autodiff {
  method #DifferentiableRequirement.f!1: <Self where Self : DifferentiableRequirement> (Self) -> (Float) -> Float : @$s23witness_tables_autodiff25DifferentiableConformanceVAA0D11RequirementA2aDP1fyS2fFTW	// protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
  autodiff_associated_function jvp 1 SU #DifferentiableRequirement.f!1: <Self where Self : DifferentiableRequirement> (Self) -> (Float) -> Float : @$s3jvp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW	// jvpSU protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
  autodiff_associated_function vjp 1 SU #DifferentiableRequirement.f!1: <Self where Self : DifferentiableRequirement> (Self) -> (Float) -> Float : @$s3vjp007SU_rgJk23witness_tables_autodiff25DifferentiableConformanceVAC0E11RequirementA2cFP1fyS2fFTW	// vjpSU protocol witness for DifferentiableRequirement.f(_:) in conformance DifferentiableConformance
}
