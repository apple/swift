// RUN: %target-sil-opt %s -module-name=autodiff_sil_function_type_parse | %target-sil-opt -module-name=autodiff_sil_function_type_parse | %FileCheck %s

sil_stage raw

import Swift

sil @examplefunc : $@convention(thin) (Float, Float, Float) -> Float

sil @examplemethod : $@convention(method) (Float, Float, Float) -> Float

// CHECK-LABEL: sil @test
sil @test : $@convention(thin) () -> () {
bb0:
  %0 = function_ref @examplefunc : $@convention(thin) (Float, Float, Float) -> Float

  %1 = differentiable_function [wrt 0 1 2] %0 : $@convention(thin) (Float, Float, Float) -> Float
  // CHECK: %2 = differentiable_function_extract [vjp] %1 : $@differentiable @convention(thin) (Float, Float, Float) -> Float
  %2 = differentiable_function_extract [vjp] %1 : $@differentiable @convention(thin) (Float, Float, Float) -> Float

  %3 = differentiable_function [wrt 0] %0 : $@convention(thin) (Float, Float, Float) -> Float
  // CHECK: %4 = differentiable_function_extract [vjp] %3 : $@differentiable @convention(thin) (Float, @nondiff Float, @nondiff Float) -> Float
  %4 = differentiable_function_extract [vjp] %3 : $@differentiable @convention(thin) (Float, @nondiff Float, @nondiff Float) -> Float

  %5 = function_ref @examplemethod : $@convention(method) (Float, Float, Float) -> Float

  %6 = differentiable_function [wrt 0 1 2] %5 : $@convention(method) (Float, Float, Float) -> Float
  // CHECK: %7 = differentiable_function_extract [vjp] %6 : $@differentiable @convention(method) (Float, Float, Float) -> Float
  %7 = differentiable_function_extract [vjp] %6 : $@differentiable @convention(method) (Float, Float, Float) -> Float

  %8 = differentiable_function [wrt 0] %5 : $@convention(method) (Float, Float, Float) -> Float
  // CHECK: %9 = differentiable_function_extract [vjp] %8 : $@differentiable @convention(method) (Float, @nondiff Float, @nondiff Float) -> Float
  %9 = differentiable_function_extract [vjp] %8 : $@differentiable @convention(method) (Float, @nondiff Float, @nondiff Float) -> Float

  %ret = tuple ()
  return %ret : $()
}

sil @takeAndReturnLinear : $@convention(thin) (@differentiable(linear) (Float) -> Float) -> @differentiable(linear) (Float) -> Float {
bb0(%0 : $@differentiable(linear) (Float) -> Float):
  return %0 : $@differentiable(linear) (Float) -> Float
}

// CHECK-LABEL: sil @takeAndReturnLinear : $@convention(thin) (@differentiable(linear) (Float) -> Float) -> @differentiable(linear) (Float) -> Float {
// CHECK: bb0([[ARG:%.*]] : $@differentiable(linear) (Float) -> Float):
// CHECK:   return [[ARG]] : $@differentiable(linear) (Float) -> Float
// CHECK: }
